<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= locals.title || topic.title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/forum.css">
    <style>
        /* Estilos adicionales para corregir problemas visuales */
        .fas, .far, .fab {
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }
        
        .reply-form-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .reply-form-container h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: #333;
        }
        
        #replyForm .form-group {
            margin-bottom: 15px;
        }
        
        #replyForm textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
        }
        
        #replyForm .form-actions {
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <%- include('../../../partials/dashboard/sidebar', { 
        user: locals.user || {},
        isAuthenticated: !!locals.user,
        currentPage: 'trader-call-comunidad'
    }) %>
    
    <div class="dashboard-content">
        <%- include('../../../partials/dashboard/header', { 
            user: locals.user || {},
            isAuthenticated: !!locals.user,
            title: locals.title || topic.title
        }) %>
        
        <div class="forum-container">
            <!-- Breadcrumb / Migas de pan -->
            <div class="breadcrumb">
                <a href="/dashboard/trader-call/comunidad">Comunidad</a> &gt; 
                <a href="/dashboard/trader-call/forum/category/<%= topic.category._id %>"><%= topic.category.name %></a> &gt; 
                <span><%= topic.title %></span>
            </div>
            
            <!-- Tema principal - SOLO UNA VEZ -->
            <div class="topic-container">
                <div class="topic-header">
                    <h1><%= topic.title %></h1>
                    <div class="topic-meta">
                        <div class="topic-author">
                            <img src="<%= topic.author.avatar || '/img/default-avatar.png' %>" alt="<%= topic.author.nombre %>" class="author-avatar">
                            <span class="author-name"><%= topic.author.nombre %></span>
                        </div>
                        <div class="topic-info">
                            <span><i class="fas fa-calendar"></i> <%= new Date(topic.createdAt).toLocaleDateString() %></span>
                            <span><i class="fas fa-eye"></i> <%= topic.views %> vistas</span>
                            <span><i class="fas fa-comment"></i> <%= topic.replyCount || 0 %> respuestas</span>
                            
                            <!-- Botón de eliminar (solo visible para administradores o autor) -->
                            <% if ((user.role === 'admin') || (topic.author._id.toString() === user._id.toString())) { %>
                                <button class="delete-button" data-id="<%= topic._id %>" data-type="topic">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
                <div class="topic-content">
                    <%= topic.content %>
                </div>
            </div>
            
            <!-- Respuestas al tema -->
            <div class="topic-replies">
                <h3>Respuestas (<%= replies.length %>)</h3>
                
                <% if (replies.length > 0) { %>
                    <div class="replies-list">
                        <% replies.forEach((reply, index) => { %>
                            <div class="reply-item" id="reply-<%= reply._id %>">
                                <div class="reply-header">
                                    <div class="reply-author">
                                        <img src="<%= reply.author.avatar || '/img/default-avatar.png' %>" alt="<%= reply.author.nombre %>" class="author-avatar">
                                        <span class="author-name"><%= reply.author.nombre %></span>
                                    </div>
                                    <div class="reply-date">
                                        <%= new Date(reply.createdAt).toLocaleDateString() %> <%= new Date(reply.createdAt).toLocaleTimeString() %>
                                        
                                        <!-- Botón de eliminar (solo visible para administradores o autor) -->
                                        <% if ((user.role === 'admin') || (reply.author._id.toString() === user._id.toString())) { %>
                                            <button class="delete-button" data-id="<%= reply._id %>" data-type="reply">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="reply-content">
                                    <%= reply.content %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } else { %>
                    <p class="no-replies">No hay respuestas todavía. ¡Sé el primero en responder!</p>
                <% } %>
            </div>
            
            <!-- Formulario para responder -->
            <div class="reply-form-container">
                <h3>Responder a este tema</h3>
                <form id="replyForm" action="/dashboard/trader-call/forum/reply" method="POST">
                    <input type="hidden" name="topicId" value="<%= topic._id %>">
                    <div class="form-group">
                        <label for="replyContent">Tu respuesta:</label>
                        <textarea id="replyContent" name="content" rows="5" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="primary-button">
                            <i class="fas fa-paper-plane"></i> Enviar respuesta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- JavaScript para manejar la eliminación -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar la eliminación de temas y respuestas
            const deleteButtons = document.querySelectorAll('.delete-button');
            
            deleteButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    
                    if (!id || !type) return;
                    
                    // Confirmar eliminación
                    if (!confirm(`¿Estás seguro de que deseas eliminar ${type === 'topic' ? 'este tema' : 'esta respuesta'}? Esta acción no se puede deshacer.`)) {
                        return;
                    }
                    
                    try {
                        // Enviar solicitud de eliminación
                        const response = await fetch(`/dashboard/trader-call/forum/${type}/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Si se eliminó un tema, redirigir a la categoría
                            if (type === 'topic') {
                                window.location.href = '/dashboard/trader-call/forum/category/<%= topic.category._id %>';
                            } else {
                                // Si se eliminó una respuesta, eliminar el elemento del DOM
                                document.getElementById(`reply-${id}`).remove();
                            }
                        } else {
                            alert(`Error: ${data.message}`);
                        }
                    } catch (error) {
                        console.error('Error al eliminar:', error);
                        alert('Ha ocurrido un error al intentar eliminar. Por favor, inténtalo de nuevo.');
                    }
                });
            });
        });
    </script>
</body>
</html> 